<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#1a5c2a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Lista Fertrac">
<title>Lista de Precios - Fertrac</title>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
  :root {
    --green: #F47920;
    --green-light: #F69444;
    --green-pale: #FEF0E6;
    --yellow: #58595B;
    --border: #ddd;
    --text: #222;
    --subtext: #666;
    --shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Segoe UI', sans-serif; background: #f5f5f5; color: var(--text); }
  header {
    background: white;
    padding: 10px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 100;
    border-bottom: 3px solid var(--green);
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  }
  .header-title {
    font-size: 0.95rem;
    font-weight: 700;
    color: var(--green);
    letter-spacing: 0.3px;
  }
  #sync-btn {
    background: var(--green);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 7px 16px;
    font-size: 0.8rem;
    font-weight: 700;
    cursor: pointer;
    transition: background 0.2s;
  }
  #sync-btn:hover { background: var(--green-light); }
  #sync-btn:disabled { opacity: 0.6; }

  /* GO TOP BUTTON */
  #go-top-btn {
    display: none;
    position: fixed;
    bottom: 24px;
    right: 20px;
    background: var(--green);
    color: white;
    border: none;
    border-radius: 24px;
    padding: 10px 18px;
    font-size: 0.85rem;
    font-weight: 700;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(244,121,32,0.4);
    z-index: 50;
    transition: all 0.2s;
  }
  #go-top-btn.visible { display: flex; align-items: center; gap: 6px; }
  #go-top-btn:hover { background: var(--green-light); transform: translateY(-2px); }
  main { max-width: 900px; margin: 0 auto; padding: 16px; }
  .instructions {
    background: white;
    border-left: 4px solid var(--yellow);
    border-radius: 8px;
    padding: 12px 16px;
    margin-bottom: 16px;
    font-size: 0.82rem;
    color: var(--subtext);
    box-shadow: var(--shadow);
  }
  .instructions strong { color: var(--green); display: block; margin-bottom: 4px; }
  .search-box {
    background: white;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 16px;
    box-shadow: var(--shadow);
  }
  .search-row { display: flex; gap: 8px; margin-bottom: 12px; }
  #search-input {
    flex: 1;
    padding: 10px 14px;
    border: 2px solid var(--border);
    border-radius: 8px;
    font-size: 0.95rem;
    outline: none;
  }
  #search-input:focus { border-color: var(--green-light); }
  #clear-btn {
    background: #eee;
    border: none;
    border-radius: 8px;
    padding: 10px 14px;
    cursor: pointer;
    font-size: 0.85rem;
    color: #555;
  }
  .filters-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 8px;
  }
  .filters-grid select {
    width: 100%;
    padding: 8px 10px;
    border: 1.5px solid var(--border);
    border-radius: 8px;
    font-size: 0.82rem;
    background: white;
    outline: none;
  }
  .results-meta { font-size: 0.85rem; color: var(--subtext); margin-bottom: 10px; }
  .results-meta strong { color: var(--green); }
  .table-wrapper {
    background: white;
    border-radius: 12px;
    box-shadow: var(--shadow);
    overflow: hidden;
    margin-bottom: 16px;
  }
  table { width: 100%; border-collapse: collapse; }
  thead { background: var(--green); color: white; }
  thead th { padding: 11px 14px; text-align: left; font-size: 0.82rem; font-weight: 600; }
  tbody tr { border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.15s; }
  tbody tr:hover { background: var(--green-pale); }
  tbody tr.selected { background: #d4edda; }
  tbody td { padding: 10px 14px; font-size: 0.85rem; }
  .tag {
    background: var(--green-pale);
    color: var(--green);
    border-radius: 12px;
    padding: 2px 8px;
    font-size: 0.75rem;
    font-weight: 600;
  }
  .detail-panel {
    background: white;
    border-radius: 12px;
    box-shadow: var(--shadow);
    overflow: hidden;
    display: none;
  }
  .detail-panel.visible { display: block; }
  .detail-header {
    background: var(--green);
    color: white;
    padding: 14px 18px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .detail-header h2 { font-size: 1rem; }
  .close-btn {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    border-radius: 50%;
    width: 28px;
    height: 28px;
    cursor: pointer;
    font-size: 1.1rem;
  }
  .detail-body { padding: 18px; }
  .detail-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }
  @media (max-width: 600px) {
    .detail-grid { grid-template-columns: 1fr; }
    .filters-grid { grid-template-columns: 1fr 1fr; }
  }
  .detail-section h3 {
    font-size: 0.78rem;
    text-transform: uppercase;
    color: var(--subtext);
    letter-spacing: 0.8px;
    margin-bottom: 10px;
    border-bottom: 2px solid var(--green-pale);
    padding-bottom: 4px;
  }
  .detail-row { margin-bottom: 8px; }
  .detail-row label { font-size: 0.75rem; color: var(--subtext); display: block; }
  .detail-row span { font-size: 0.9rem; font-weight: 600; }
  .price-cards {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 10px;
    margin-top: 8px;
  }
  .price-card {
    background: var(--green-pale);
    border-radius: 10px;
    padding: 12px;
    text-align: center;
  }
  .price-card label { font-size: 0.72rem; color: var(--subtext); display: block; margin-bottom: 4px; }
  .price-card .amount { font-size: 1.05rem; font-weight: 700; color: var(--green); }
  .price-card.promo { background: #fff8e1; }
  .price-card.promo .amount { color: #e65100; }
  .product-image {
    width: 100%;
    max-width: 200px;
    border-radius: 10px;
    border: 1px solid var(--border);
    display: block;
    margin: 0 auto 12px;
    object-fit: contain;
    height: 160px;
    background: #f5f5f5;
  }
  .no-image {
    width: 100%;
    max-width: 200px;
    height: 160px;
    border-radius: 10px;
    border: 2px dashed var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--subtext);
    font-size: 0.8rem;
    margin: 0 auto 12px;
  }
  .inv-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    font-weight: 700;
    font-size: 0.9rem;
  }
  .inv-ok { background: #d4edda; color: #155724; }
  .inv-low { background: #fff3cd; color: #856404; }
  .inv-none { background: #f8d7da; color: #721c24; }
  #sync-status {
    font-size: 0.75rem;
    text-align: center;
    color: var(--subtext);
    padding: 6px;
    margin-bottom: 10px;
  }
  .loading { text-align: center; padding: 40px; color: var(--subtext); }
  .spinner {
    width: 36px; height: 36px;
    border: 4px solid #eee;
    border-top-color: var(--green);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto 12px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .empty-state { text-align: center; padding: 40px; color: var(--subtext); font-size: 0.9rem; }
  .offline-banner {
    background: #fff3cd;
    color: #856404;
    text-align: center;
    padding: 8px;
    font-size: 0.82rem;
    display: none;
  }
  .offline-banner.visible { display: block; }

  /* LOGIN SCREEN */
  #login-screen {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    background: #f5f5f5;
    padding: 20px;
  }
  .login-card {
    background: white;
    border-radius: 14px;
    padding: 40px 32px;
    max-width: 380px;
    width: 100%;
    box-shadow: 0 4px 24px rgba(0,0,0,0.1);
    text-align: center;
  }
  .login-logo { height: 60px; object-fit: contain; margin-bottom: 20px; }
  .login-card h2 { font-size: 1.3rem; color: var(--gray-dark); margin-bottom: 8px; }
  .login-card p { font-size: 0.85rem; color: var(--gray-mid); margin-bottom: 28px; }
  .login-divider { border: none; border-top: 1px solid var(--border); margin: 20px 0; }
  #access-denied {
    display: none;
    background: #f8d7da;
    color: #721c24;
    border-radius: 8px;
    padding: 12px;
    font-size: 0.85rem;
    margin-top: 16px;
  }
  #app-content { display: none; }
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="login-screen">
  <div class="login-card">
    <img src="https://raw.githubusercontent.com/developments-fertrac/lista-precios-fertrac/main/logo.png"
         alt="Fertrac" class="login-logo"
         onerror="this.style.display='none'">
    <h2>Lista de Precios</h2>
    <p>Inicia sesiÃ³n con tu cuenta corporativa de Fertrac para continuar</p>
    <div id="g_id_onload"
         data-client_id="748686271759-3ebepqvfssbpn650m8pu1l6umdq093fo.apps.googleusercontent.com"
         data-callback="handleCredential"
         data-auto_select="true">
    </div>
    <div class="g_id_signin"
         data-type="standard"
         data-size="large"
         data-theme="outline"
         data-text="signin_with"
         data-shape="rectangular"
         data-logo_alignment="left"
         data-width="280">
    </div>
    <div id="access-denied">â›” Acceso denegado. Solo usuarios con correo @fertrac.com pueden acceder.</div>
  </div>
</div>

<!-- APP CONTENT -->
<div id="app-content">
<header>
  <div style="display:flex;align-items:center;gap:14px">
    <img src="https://raw.githubusercontent.com/developments-fertrac/lista-precios-fertrac/main/logo.png"
         alt="Fertrac" style="height:40px;object-fit:contain"
         onerror="this.style.display='none'">
    <span class="header-title">Lista de Precios</span>
  </div>
  <div style="display:flex;align-items:center;gap:10px">
    <span id="sync-status" style="font-size:0.72rem;color:#aaa"></span>
    <button id="sync-btn" onclick="syncData()">ðŸ”„ Sincronizar</button>
  </div>
</header>

<!-- GO TOP BUTTON -->
<button id="go-top-btn" onclick="goTop()">â†‘ Ir arriba</button>

<div class="offline-banner" id="offline-banner">
  ðŸ“µ Sin conexiÃ³n â€” mostrando datos guardados
</div>

<main>

  <div class="instructions">
    <strong>ðŸ“‹ CÃ³mo usar:</strong>
    1. Escribe una palabra clave o referencia en el buscador. &nbsp;&nbsp;
    2. Usa los filtros para refinar. &nbsp;&nbsp;
    3. Toca un producto para ver el detalle completo.
  </div>

  <div class="search-box">
    <div class="search-row">
      <input type="text" id="search-input" placeholder="ðŸ” Buscar por referencia, producto, marca..." oninput="applyFilters()">
      <button id="clear-btn" onclick="clearAll()">ðŸ§¹ Limpiar</button>
    </div>
    <div class="filters-grid">
      <select id="f-categoria" onchange="applyFilters()"><option value="">CategorÃ­a</option></select>
      <select id="f-subcategoria" onchange="applyFilters()"><option value="">SubcategorÃ­a</option></select>
      <select id="f-tipo" onchange="applyFilters()"><option value="">Tipo de producto</option></select>
      <select id="f-linea" onchange="applyFilters()"><option value="">LÃ­nea</option></select>
      <select id="f-marca" onchange="applyFilters()"><option value="">Marca</option></select>
      <select id="f-aplicacion" onchange="applyFilters()"><option value="">AplicaciÃ³n</option></select>
    </div>
  </div>

  <div class="results-meta" id="results-meta"></div>

  <div class="table-wrapper" id="table-wrapper">
    <div class="empty-state">Cargando datos...</div>
  </div>

  <div class="detail-panel" id="detail-panel">
    <div class="detail-header">
      <h2 id="detail-title">Detalle del producto</h2>
      <button class="close-btn" onclick="closeDetail()">âœ•</button>
    </div>
    <div class="detail-body" id="detail-body"></div>
  </div>
</main>

<script>
const CLIENT_ID = '748686271759-3ebepqvfssbpn650m8pu1l6umdq093fo.apps.googleusercontent.com';
const ALLOWED_DOMAIN = 'fertrac.com';
let userEmail = null;

function handleCredential(response) {
  const payload = JSON.parse(atob(response.credential.split('.')[1]));
  const email = payload.email;
  if (email && email.endsWith('@' + ALLOWED_DOMAIN)) {
    userEmail = email;
    localStorage.setItem('fertrac_user', email);
    showApp();
  } else {
    document.getElementById('access-denied').style.display = 'block';
  }
}

function showApp() {
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('app-content').style.display = 'block';
  initApp();
}

function checkAuth() {
  const saved = localStorage.getItem('fertrac_user');
  if (saved && saved.endsWith('@' + ALLOWED_DOMAIN)) {
    userEmail = saved;
    showApp();
  }
  // Otherwise login screen stays visible
}

window.onload = function() { checkAuth(); };

const APPS_SCRIPT_URL = 'https://script.google.com/a/macros/fertrac.com/s/AKfycbztitt85lzEy2Bl7iecjX-IS56DHY1OOxPVlPbyvwxWZpDofLQsdh-stXxBvE_xIW3L/exec';
const ACCESS_KEY = 'fertrac2024';

const C = {
  REF: 0, FOTO: 1, ALTERNOS: 2, PRODUCTO: 3, CATEGORIA: 4,
  SUBCATEGORIA: 5, TIPO: 6, LINEA: 7, MARCA: 8, APLICACION: 9,
  PRECIO_BRUTO: 10, NETO_5: 11, NETO_8: 12, PRECIO_PROMO: 13,
  UND_ESCALA: 14, UND_MIN: 15, UND_MAX: 16, PROMO_FIN: 17,
  INV: 18, UND_RM: 19, UND_RMC: 20, CONDICION: 21
};

let allData = [];
let filtered = [];

// â”€â”€ SERVICE WORKER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/lista-precios-fertrac/sw.js', { scope: '/lista-precios-fertrac/' })
    .then(() => console.log('SW registrado correctamente'))
    .catch(err => console.log('SW error:', err));
}

// â”€â”€ STORAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveData(data) {
  try {
    localStorage.setItem('fertrac_data', JSON.stringify(data));
    localStorage.setItem('fertrac_updated', new Date().toLocaleString('es-CO'));
  } catch(e) { console.warn('Storage full', e); }
}
function loadData() {
  try { const d = localStorage.getItem('fertrac_data'); return d ? JSON.parse(d) : null; }
  catch(e) { return null; }
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initApp() {
  const saved = loadData();
  if (saved && saved.length > 0) {
    allData = saved;
    const ts = localStorage.getItem('fertrac_updated');
    document.getElementById('sync-status').textContent = ts ? 'Ãšltima sincronizaciÃ³n: ' + ts : '';
    buildFilters();
    applyFilters();
  } else {
    document.getElementById('table-wrapper').innerHTML =
      '<div class="empty-state">ConÃ©ctate a internet para cargar los datos por primera vez</div>';
  }

  if (navigator.onLine) {
    syncData();
  } else {
    showOfflineBanner();
  }

  window.addEventListener('online', () => {
    document.getElementById('offline-banner').classList.remove('visible');
    syncData();
  });
  window.addEventListener('offline', () => showOfflineBanner());
};

function showOfflineBanner() {
  document.getElementById('offline-banner').classList.add('visible');
  document.getElementById('sync-status').textContent = '';
}

// â”€â”€ SYNC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function syncData() {
  if (!navigator.onLine) { showOfflineBanner(); return; }
  const status = document.getElementById('sync-status');
  const btn = document.getElementById('sync-btn');
  status.textContent = 'ðŸ”„ Sincronizando...';
  btn.textContent = 'ðŸ”„ Cargando...';
  btn.disabled = true;

  if (allData.length === 0) {
    document.getElementById('table-wrapper').innerHTML =
      '<div class="loading"><div class="spinner"></div>Cargando datos...</div>';
  }

  try {
    const res = await fetch(APPS_SCRIPT_URL + '?key=' + ACCESS_KEY);
    const json = await res.json();
    if (json.error) throw new Error(json.error);

    allData = json.data.slice(1).map(row =>
      row.map(cell => cell === null || cell === undefined ? '' : String(cell).trim())
    );

    saveData(allData);
    const ts = localStorage.getItem('fertrac_updated');
    status.textContent = 'âœ… ' + allData.length + ' productos';
    btn.textContent = 'ðŸ”„ Sincronizar';
    btn.disabled = false;
    buildFilters();
    applyFilters();
  } catch(e) {
    status.textContent = 'âš ï¸ Error al sincronizar';
    btn.textContent = 'ðŸ”„ Sincronizar';
    btn.disabled = false;
    const saved = loadData();
    if (saved && saved.length > 0) { allData = saved; buildFilters(); applyFilters(); }
    else document.getElementById('table-wrapper').innerHTML =
      '<div class="empty-state">No hay datos guardados. ConÃ©ctate a internet para sincronizar.</div>';
  }
}

// â”€â”€ FILTERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildFilters() {
  const fields = [
    { id: 'f-categoria', col: C.CATEGORIA, label: 'CategorÃ­a' },
    { id: 'f-subcategoria', col: C.SUBCATEGORIA, label: 'SubcategorÃ­a' },
    { id: 'f-tipo', col: C.TIPO, label: 'Tipo de producto' },
    { id: 'f-linea', col: C.LINEA, label: 'LÃ­nea' },
    { id: 'f-marca', col: C.MARCA, label: 'Marca' },
    { id: 'f-aplicacion', col: C.APLICACION, label: 'AplicaciÃ³n' },
  ];
  fields.forEach(f => {
    const sel = document.getElementById(f.id);
    const vals = [...new Set(allData.map(r => r[f.col]).filter(Boolean))].sort();
    sel.innerHTML = '<option value="">' + f.label + '</option>' +
      vals.map(v => '<option value="' + v + '">' + v + '</option>').join('');
  });
}

function applyFilters() {
  const q = document.getElementById('search-input').value.toLowerCase();
  const cat = document.getElementById('f-categoria').value;
  const sub = document.getElementById('f-subcategoria').value;
  const tipo = document.getElementById('f-tipo').value;
  const linea = document.getElementById('f-linea').value;
  const marca = document.getElementById('f-marca').value;
  const aplic = document.getElementById('f-aplicacion').value;

  filtered = allData.filter(r => {
    if (q && !(r[C.REF]+' '+r[C.PRODUCTO]+' '+r[C.MARCA]+' '+r[C.ALTERNOS]).toLowerCase().includes(q)) return false;
    if (cat && r[C.CATEGORIA] !== cat) return false;
    if (sub && r[C.SUBCATEGORIA] !== sub) return false;
    if (tipo && r[C.TIPO] !== tipo) return false;
    if (linea && r[C.LINEA] !== linea) return false;
    if (marca && r[C.MARCA] !== marca) return false;
    if (aplic && r[C.APLICACION] !== aplic) return false;
    return true;
  });

  renderTable();
  document.getElementById('results-meta').innerHTML =
    allData.length > 0
      ? 'Mostrando <strong>' + filtered.length + '</strong> de <strong>' + allData.length + '</strong> productos'
      : '';
}

function clearAll() {
  document.getElementById('search-input').value = '';
  ['f-categoria','f-subcategoria','f-tipo','f-linea','f-marca','f-aplicacion']
    .forEach(id => { document.getElementById(id).value = ''; });
  closeDetail();
  applyFilters();
}

// â”€â”€ TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTable() {
  const wrapper = document.getElementById('table-wrapper');
  if (filtered.length === 0) {
    wrapper.innerHTML = '<div class="empty-state">No se encontraron productos</div>';
    return;
  }
  const show = filtered.slice(0, 200);
  const rows = show.map(r => {
    const idx = allData.indexOf(r);
    return '<tr onclick="showDetail(' + idx + ')" data-idx="' + idx + '">' +
      '<td><strong>' + (r[C.REF]||'â€”') + '</strong></td>' +
      '<td><span class="tag">' + (r[C.MARCA]||'â€”') + '</span></td>' +
      '<td>' + (r[C.PRODUCTO]||'â€”') + '</td>' +
      '</tr>';
  }).join('');
  wrapper.innerHTML =
    '<table><thead><tr><th>Referencia</th><th>Marca</th><th>Producto</th></tr></thead>' +
    '<tbody>' + rows + '</tbody></table>' +
    (filtered.length > 200 ? '<div style="text-align:center;padding:10px;font-size:0.8rem;color:#888">Mostrando 200 de ' + filtered.length + ' resultados. Refina tu bÃºsqueda.</div>' : '');
}

// â”€â”€ DETAIL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function extractDriveId(url) {
  if (!url) return null;
  const match = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
  if (match) return match[1];
  const match2 = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
  if (match2) return match2[1];
  return null;
}

async function loadImage(fileId, imgElement) {
  try {
    const res = await fetch(APPS_SCRIPT_URL + '?key=' + ACCESS_KEY + '&img=' + fileId);
    const dataUrl = await res.text();
    if (dataUrl.startsWith('data:')) imgElement.src = dataUrl;
  } catch(e) {
    imgElement.style.display = 'none';
  }
}

function showDetail(idx) {
  const r = allData[idx];
  if (!r) return;

  document.querySelectorAll('tbody tr').forEach(tr => tr.classList.remove('selected'));
  const tr = document.querySelector('tr[data-idx="' + idx + '"]');
  if (tr) tr.classList.add('selected');

  const inv = parseFloat(r[C.INV]) || 0;
  const invClass = inv > 10 ? 'inv-ok' : inv > 0 ? 'inv-low' : 'inv-none';
  const invText = inv > 10 ? inv + ' unidades' : inv > 0 ? inv + ' unidades (bajo)' : 'Sin stock';

  const fileId = extractDriveId(r[C.FOTO]);
  const imgHtml = fileId
    ? '<img id="detail-img" class="product-image" alt="Foto producto" onclick="openModal(this)" style="cursor:zoom-in">'
    : '<div class="no-image">Sin imagen</div>';

  document.getElementById('detail-title').textContent = r[C.REF] || 'Detalle';
  document.getElementById('detail-body').innerHTML =
    '<div class="detail-grid">' +
      '<div>' +
        imgHtml +
        '<div class="detail-section">' +
          '<h3>ðŸ›  InformaciÃ³n tÃ©cnica</h3>' +
          drow('Referencia', r[C.REF]) +
          drow('Producto', r[C.PRODUCTO]) +
          drow('Marca', r[C.MARCA]) +
          drow('LÃ­nea', r[C.LINEA]) +
          drow('AplicaciÃ³n', r[C.APLICACION]) +
          drow('Refs. alternas / intercambio', r[C.ALTERNOS]) +
        '</div>' +
      '</div>' +
      '<div>' +
        '<div class="detail-section">' +
          '<h3>ðŸ’° Precios</h3>' +
          '<div class="price-cards">' +
            pcard('Precio Bruto', r[C.PRECIO_BRUTO], false) +
            pcard('Neto -5%', r[C.NETO_5], false) +
            pcard('Neto -8%', r[C.NETO_8], false) +
            (r[C.PRECIO_PROMO] ? pcard('ðŸ”¥ Precio Promo', r[C.PRECIO_PROMO], true) : '') +
          '</div>' +
        '</div>' +
        '<div class="detail-section" style="margin-top:16px">' +
          '<h3>ðŸ“¦ InformaciÃ³n comercial</h3>' +
          drow('CondiciÃ³n', r[C.CONDICION]) +
          '<div class="detail-row"><label>Inventario</label><span class="inv-badge ' + invClass + '">' + invText + '</span></div>' +
          drow('Unid. mÃ­n. de venta', r[C.UND_MIN]) +
          drow('Unid. mÃ¡x. de venta', r[C.UND_MAX]) +
          drow('Escala (â‰¥ unidades)', r[C.UND_ESCALA]) +
          drow('Und. RM', r[C.UND_RM]) +
          drow('Und. RMC', r[C.UND_RMC]) +
          (r[C.PROMO_FIN] ? '<div class="detail-row"><label>Promo finaliza en</label><span style="color:#e65100;font-weight:700">' + r[C.PROMO_FIN] + '</span></div>' : '') +
        '</div>' +
      '</div>' +
    '</div>';

  const panel = document.getElementById('detail-panel');
  panel.classList.add('visible');
  panel.scrollIntoView({ behavior: 'smooth', block: 'start' });

  // Load image async if online
  if (fileId && navigator.onLine) {
    const imgEl = document.getElementById('detail-img');
    if (imgEl) loadImage(fileId, imgEl);
  }
}

function closeDetail() {
  document.getElementById('detail-panel').classList.remove('visible');
  document.querySelectorAll('tbody tr').forEach(tr => tr.classList.remove('selected'));
}

function drow(label, val) {
  return '<div class="detail-row"><label>' + label + '</label><span>' + (val||'â€”') + '</span></div>';
}
function pcard(label, val, isPromo) {
  return '<div class="price-card' + (isPromo?' promo':'') + '"><label>' + label + '</label><div class="amount">' + formatPrice(val) + '</div></div>';
}
function openModal(imgEl) {
  const modal = document.getElementById('img-modal');
  document.getElementById('img-modal-src').src = imgEl.src;
  modal.style.display = 'flex';
  document.body.style.overflow = 'hidden';
}
function closeModal() {
  document.getElementById('img-modal').style.display = 'none';
  document.body.style.overflow = '';
}

function formatPrice(val) {
  if (!val) return 'â€”';
  const n = parseFloat(String(val).replace(/[^0-9.]/g, ''));
  if (isNaN(n)) return val;
  return '$' + n.toLocaleString('es-CO', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
}

function goTop() {
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Show/hide go-top button based on scroll
window.addEventListener('scroll', () => {
  const btn = document.getElementById('go-top-btn');
  if (window.scrollY > 300) btn.classList.add('visible');
  else btn.classList.remove('visible');
});
</script>
</div><!-- end app-content -->

<!-- IMAGE MODAL -->
<div id="img-modal" onclick="closeModal()" style="
  display:none;position:fixed;inset:0;z-index:999;
  background:rgba(0,0,0,0.85);
  align-items:center;justify-content:center;padding:20px;">
  <img id="img-modal-src" style="max-width:100%;max-height:90vh;border-radius:10px;object-fit:contain;">
</div>
</body>
</html>
