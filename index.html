<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#F47920">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Lista Fertrac">
<title>Lista de Precios - Fertrac</title>
<style>
  :root {
    --orange: #F47920;
    --orange-light: #F69444;
    --orange-pale: #FEF0E6;
    --gray-dark: #58595B;
    --gray-mid: #888;
    --gray-light: #f5f5f5;
    --border: #e0e0e0;
    --text: #333;
    --shadow: 0 2px 8px rgba(0,0,0,0.08);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Segoe UI', Arial, sans-serif; background: #f5f5f5; color: var(--text); }

  /* HEADER */
  header {
    background: white;
    padding: 12px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 3px solid var(--orange);
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: var(--shadow);
  }
  .header-logo { height: 44px; object-fit: contain; }
  .header-right { display: flex; align-items: center; gap: 12px; }
  #sync-btn {
    background: var(--orange);
    color: white;
    border: none;
    border-radius: 6px;
    padding: 7px 16px;
    font-size: 0.82rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
  }
  #sync-btn:hover { background: var(--orange-light); }
  #sync-btn:disabled { opacity: 0.6; }

  /* OFFLINE BANNER */
  .offline-banner {
    background: #fff3cd;
    color: #856404;
    text-align: center;
    padding: 8px;
    font-size: 0.82rem;
    display: none;
    border-bottom: 1px solid #ffc107;
  }
  .offline-banner.visible { display: block; }

  /* MAIN */
  main { max-width: 960px; margin: 0 auto; padding: 20px 16px; }

  /* HERO */
  .hero {
    background: white;
    border-radius: 10px;
    padding: 24px 28px;
    margin-bottom: 20px;
    box-shadow: var(--shadow);
    display: flex;
    gap: 24px;
    align-items: flex-start;
  }
  .hero-logo { height: 70px; object-fit: contain; flex-shrink: 0; }
  .hero-content h1 {
    font-size: 2rem;
    color: var(--orange);
    font-weight: 700;
    margin-bottom: 12px;
  }
  .hero-content ol { padding-left: 18px; }
  .hero-content li { font-size: 0.88rem; color: var(--gray-dark); margin-bottom: 6px; line-height: 1.5; }
  .hero-content .importante {
    margin-top: 12px;
    font-size: 0.85rem;
    color: var(--gray-dark);
  }
  @media (max-width: 600px) {
    .hero { flex-direction: column; }
    .hero-logo { height: 50px; }
    .hero-content h1 { font-size: 1.5rem; }
  }

  /* SEARCH SECTION */
  .search-section {
    background: white;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: var(--shadow);
  }
  .search-input-wrap {
    position: relative;
    margin-bottom: 16px;
  }
  #search-input {
    width: 100%;
    padding: 11px 16px;
    border: 1.5px solid var(--border);
    border-radius: 8px;
    font-size: 0.95rem;
    outline: none;
    color: var(--text);
    transition: border 0.2s;
  }
  #search-input::placeholder { color: #aaa; }
  #search-input:focus { border-color: var(--orange); }

  .filters-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 10px;
    margin-bottom: 14px;
  }
  .filters-grid select {
    width: 100%;
    padding: 9px 12px;
    border: 1.5px solid var(--border);
    border-radius: 8px;
    font-size: 0.83rem;
    background: white;
    color: var(--text);
    outline: none;
    cursor: pointer;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }
  .filters-grid select:focus { border-color: var(--orange); }

  #clear-btn {
    display: block;
    width: 100%;
    max-width: 260px;
    margin: 0 auto;
    padding: 10px;
    background: white;
    border: 2px dashed var(--border);
    border-radius: 24px;
    font-size: 0.88rem;
    color: var(--gray-mid);
    cursor: pointer;
    transition: all 0.2s;
    letter-spacing: 0.3px;
  }
  #clear-btn:hover { border-color: var(--orange); color: var(--orange); }

  /* RESULTS */
  .results-section {
    background: white;
    border-radius: 10px;
    box-shadow: var(--shadow);
    overflow: hidden;
    margin-bottom: 20px;
  }
  .results-header {
    padding: 14px 20px;
    display: flex;
    align-items: baseline;
    gap: 10px;
    border-bottom: 1px solid var(--border);
  }
  .results-header h2 { font-size: 1.1rem; color: var(--text); font-weight: 700; }
  .results-count {
    font-size: 0.85rem;
    color: var(--gray-mid);
    font-weight: 400;
  }
  table { width: 100%; border-collapse: collapse; }
  thead { background: var(--gray-light); }
  thead th {
    padding: 10px 16px;
    text-align: left;
    font-size: 0.8rem;
    font-weight: 700;
    color: var(--gray-dark);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 2px solid var(--border);
  }
  tbody tr { border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.12s; }
  tbody tr:hover { background: var(--orange-pale); }
  tbody tr.selected { background: #fde8d4; }
  tbody td { padding: 10px 16px; font-size: 0.85rem; }
  .ref-cell { font-weight: 700; color: var(--gray-dark); font-size: 0.82rem; }
  .marca-tag {
    background: var(--orange-pale);
    color: var(--orange);
    border-radius: 4px;
    padding: 2px 8px;
    font-size: 0.75rem;
    font-weight: 700;
    white-space: nowrap;
  }

  /* DETAIL */
  .detail-panel {
    background: white;
    border-radius: 10px;
    box-shadow: var(--shadow);
    overflow: hidden;
    display: none;
    margin-bottom: 20px;
  }
  .detail-panel.visible { display: block; }
  .detail-close-row {
    display: flex;
    justify-content: flex-end;
    padding: 10px 16px 0;
  }
  .close-btn {
    background: none;
    border: 1.5px solid var(--border);
    border-radius: 50%;
    width: 28px;
    height: 28px;
    cursor: pointer;
    font-size: 1rem;
    color: var(--gray-mid);
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .close-btn:hover { border-color: var(--orange); color: var(--orange); }

  .detail-body { padding: 0 20px 20px; }

  /* IMAGE */
  .product-img-wrap {
    text-align: center;
    margin-bottom: 16px;
  }
  .product-image {
    max-width: 240px;
    width: 100%;
    border: 2px solid var(--orange);
    border-radius: 8px;
    object-fit: contain;
    height: 200px;
    background: #fafafa;
    display: block;
    margin: 0 auto;
  }
  .no-image {
    max-width: 240px;
    height: 200px;
    border: 2px dashed var(--border);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--gray-mid);
    font-size: 0.8rem;
    margin: 0 auto;
  }
  .ver-completa {
    display: block;
    text-align: center;
    margin-top: 6px;
    font-size: 0.8rem;
    color: var(--orange);
    text-decoration: underline;
    cursor: pointer;
  }

  /* INFO TABLES */
  .info-section { margin-bottom: 20px; }
  .info-section-title {
    color: var(--orange);
    font-size: 1rem;
    font-weight: 700;
    text-align: center;
    margin-bottom: 10px;
  }
  .info-table { width: 100%; border-collapse: collapse; border: 1.5px solid var(--orange); border-radius: 8px; overflow: hidden; }
  .info-table tr { border-bottom: 1px solid var(--border); }
  .info-table tr:last-child { border-bottom: none; }
  .info-table td:first-child {
    background: var(--gray-light);
    font-size: 0.75rem;
    font-weight: 700;
    color: var(--gray-dark);
    text-transform: uppercase;
    padding: 9px 14px;
    width: 40%;
    vertical-align: top;
  }
  .info-table td:last-child {
    padding: 9px 14px;
    font-size: 0.85rem;
    color: var(--text);
  }

  .detail-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }
  @media (max-width: 640px) {
    .detail-grid { grid-template-columns: 1fr; }
    .filters-grid { grid-template-columns: 1fr 1fr; }
  }

  /* BADGES */
  .inv-badge {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 4px;
    font-weight: 700;
    font-size: 0.85rem;
  }
  .inv-ok { background: #d4edda; color: #155724; }
  .inv-low { background: #fff3cd; color: #856404; }
  .inv-none { background: #f8d7da; color: #721c24; }

  /* STATUS */
  #sync-status {
    font-size: 0.75rem;
    text-align: center;
    color: var(--gray-mid);
    padding: 5px;
    margin-bottom: 8px;
  }

  /* LOADING */
  .loading { text-align: center; padding: 40px; color: var(--gray-mid); }
  .spinner {
    width: 36px; height: 36px;
    border: 4px solid #eee;
    border-top-color: var(--orange);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto 12px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .empty-state { text-align: center; padding: 40px; color: var(--gray-mid); font-size: 0.9rem; }
  .more-results { text-align: center; padding: 10px; font-size: 0.8rem; color: var(--gray-mid); border-top: 1px solid var(--border); }
</style>
</head>
<body>

<header>
  <img src="https://raw.githubusercontent.com/developments-fertrac/lista-precios-fertrac/main/logo.png"
       alt="Fertrac" class="header-logo"
       onerror="this.style.display='none'">
  <div class="header-right">
    <div id="sync-status"></div>
    <button id="sync-btn" onclick="syncData()">üîÑ Sincronizar</button>
  </div>
</header>

<div class="offline-banner" id="offline-banner">
  üìµ Sin conexi√≥n ‚Äî mostrando datos guardados
</div>

<main>

  <!-- HERO -->
  <div class="hero">
    <img src="https://raw.githubusercontent.com/developments-fertrac/lista-precios-fertrac/main/logo.png"
         alt="Fertrac" class="hero-logo"
         onerror="this.style.display='none'">
    <div class="hero-content">
      <h1>Lista de Precios</h1>
      <ol>
        <li>Haz clic en <strong>"Limpiar filtros"</strong> (antes de cada consulta).</li>
        <li>Escribe una palabra clave o referencia en el buscador.</li>
        <li>(Opcional) Filtra por Categor√≠a / Subcategor√≠a / L√≠nea / Marca / Aplicaci√≥n.</li>
        <li>En Resultados, haz clic en la referencia para ver la informaci√≥n completa.</li>
      </ol>
      <p class="importante"><strong>Importante:</strong> Para hacer una nueva b√∫squeda, vuelve a presionar <strong>"Limpiar filtros"</strong>.</p>
    </div>
  </div>

  <!-- SEARCH -->
  <div class="search-section">
    <div class="search-input-wrap">
      <input type="text" id="search-input" placeholder="Introduzca un valor" oninput="applyFilters()">
    </div>
    <div class="filters-grid">
      <select id="f-categoria" onchange="applyFilters()"><option value="">CATEGOR√çA</option></select>
      <select id="f-subcategoria" onchange="applyFilters()"><option value="">SUBCATEGOR√çA</option></select>
      <select id="f-tipo" onchange="applyFilters()"><option value="">TIPO DE PRODUCTO</option></select>
      <select id="f-linea" onchange="applyFilters()"><option value="">L√çNEA</option></select>
      <select id="f-marca" onchange="applyFilters()"><option value="">MARCA</option></select>
      <select id="f-aplicacion" onchange="applyFilters()"><option value="">APLICACI√ìN</option></select>
    </div>
    <button id="clear-btn" onclick="clearAll()">Limpiar filtros</button>
  </div>

  <!-- DETAIL PANEL -->
  <div class="detail-panel" id="detail-panel">
    <div class="detail-close-row">
      <button class="close-btn" onclick="closeDetail()">‚úï</button>
    </div>
    <div class="detail-body" id="detail-body"></div>
  </div>

  <!-- RESULTS -->
  <div class="results-section" id="results-section">
    <div class="results-header">
      <h2>Resultados</h2>
      <span class="results-count" id="results-meta"></span>
    </div>
    <div id="table-wrapper">
      <div class="empty-state">Cargando datos...</div>
    </div>
  </div>

</main>

<script>
const APPS_SCRIPT_URL = 'https://script.google.com/a/macros/fertrac.com/s/AKfycbztitt85lzEy2Bl7iecjX-IS56DHY1OOxPVlPbyvwxWZpDofLQsdh-stXxBvE_xIW3L/exec';
const ACCESS_KEY = 'fertrac2024';

const C = {
  REF: 0, FOTO: 1, ALTERNOS: 2, PRODUCTO: 3, CATEGORIA: 4,
  SUBCATEGORIA: 5, TIPO: 6, LINEA: 7, MARCA: 8, APLICACION: 9,
  PRECIO_BRUTO: 10, NETO_5: 11, NETO_8: 12, PRECIO_PROMO: 13,
  UND_ESCALA: 14, UND_MIN: 15, UND_MAX: 16, PROMO_FIN: 17,
  INV: 18, UND_RM: 19, UND_RMC: 20, CONDICION: 21
};

let allData = [];
let filtered = [];

// ‚îÄ‚îÄ SERVICE WORKER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/lista-precios-fertrac/sw.js', { scope: '/lista-precios-fertrac/' })
    .then(() => console.log('SW registrado'))
    .catch(err => console.log('SW error:', err));
}

// ‚îÄ‚îÄ STORAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveData(data) {
  try {
    localStorage.setItem('fertrac_data', JSON.stringify(data));
    localStorage.setItem('fertrac_updated', new Date().toLocaleString('es-CO'));
  } catch(e) {}
}
function loadData() {
  try { const d = localStorage.getItem('fertrac_data'); return d ? JSON.parse(d) : null; }
  catch(e) { return null; }
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.onload = function() {
  const saved = loadData();
  if (saved && saved.length > 0) {
    allData = saved;
    const ts = localStorage.getItem('fertrac_updated');
    document.getElementById('sync-status').textContent = ts ? '‚úÖ ' + ts : '';
    buildFilters(); applyFilters();
  } else {
    document.getElementById('table-wrapper').innerHTML =
      '<div class="empty-state">Con√©ctate a internet para cargar los datos por primera vez</div>';
  }
  if (navigator.onLine) syncData();
  else showOfflineBanner();
  window.addEventListener('online', () => { hideOfflineBanner(); syncData(); });
  window.addEventListener('offline', () => showOfflineBanner());
};

function showOfflineBanner() {
  document.getElementById('offline-banner').classList.add('visible');
  document.getElementById('sync-status').textContent = '';
}
function hideOfflineBanner() {
  document.getElementById('offline-banner').classList.remove('visible');
}

// ‚îÄ‚îÄ SYNC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function syncData() {
  if (!navigator.onLine) { showOfflineBanner(); return; }
  const status = document.getElementById('sync-status');
  const btn = document.getElementById('sync-btn');
  status.textContent = 'üîÑ Sincronizando...';
  btn.textContent = 'üîÑ Cargando...';
  btn.disabled = true;
  if (allData.length === 0) {
    document.getElementById('table-wrapper').innerHTML =
      '<div class="loading"><div class="spinner"></div>Cargando datos...</div>';
  }
  try {
    const res = await fetch(APPS_SCRIPT_URL + '?key=' + ACCESS_KEY);
    const json = await res.json();
    if (json.error) throw new Error(json.error);
    allData = json.data.slice(1).map(row =>
      row.map(cell => cell === null || cell === undefined ? '' : String(cell).trim())
    );
    saveData(allData);
    const ts = localStorage.getItem('fertrac_updated');
    status.textContent = '‚úÖ ' + ts;
    btn.textContent = 'üîÑ Sincronizar';
    btn.disabled = false;
    buildFilters(); applyFilters();
  } catch(e) {
    status.textContent = '';
    btn.textContent = 'üîÑ Sincronizar';
    btn.disabled = false;
    showOfflineBanner();
    const saved = loadData();
    if (saved && saved.length > 0) { allData = saved; buildFilters(); applyFilters(); }
    else document.getElementById('table-wrapper').innerHTML =
      '<div class="empty-state">Sin datos guardados. Con√©ctate a internet para sincronizar.</div>';
  }
}

// ‚îÄ‚îÄ FILTERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildFilters() {
  const fields = [
    { id: 'f-categoria', col: C.CATEGORIA, label: 'CATEGOR√çA' },
    { id: 'f-subcategoria', col: C.SUBCATEGORIA, label: 'SUBCATEGOR√çA' },
    { id: 'f-tipo', col: C.TIPO, label: 'TIPO DE PRODUCTO' },
    { id: 'f-linea', col: C.LINEA, label: 'L√çNEA' },
    { id: 'f-marca', col: C.MARCA, label: 'MARCA' },
    { id: 'f-aplicacion', col: C.APLICACION, label: 'APLICACI√ìN' },
  ];
  fields.forEach(f => {
    const sel = document.getElementById(f.id);
    const vals = [...new Set(allData.map(r => r[f.col]).filter(Boolean))].sort();
    sel.innerHTML = '<option value="">' + f.label + '</option>' +
      vals.map(v => '<option value="' + v + '">' + v + '</option>').join('');
  });
}

function applyFilters() {
  const q = document.getElementById('search-input').value.toLowerCase();
  const cat = document.getElementById('f-categoria').value;
  const sub = document.getElementById('f-subcategoria').value;
  const tipo = document.getElementById('f-tipo').value;
  const linea = document.getElementById('f-linea').value;
  const marca = document.getElementById('f-marca').value;
  const aplic = document.getElementById('f-aplicacion').value;
  filtered = allData.filter(r => {
    if (q && !(r[C.REF]+' '+r[C.PRODUCTO]+' '+r[C.MARCA]+' '+r[C.ALTERNOS]).toLowerCase().includes(q)) return false;
    if (cat && r[C.CATEGORIA] !== cat) return false;
    if (sub && r[C.SUBCATEGORIA] !== sub) return false;
    if (tipo && r[C.TIPO] !== tipo) return false;
    if (linea && r[C.LINEA] !== linea) return false;
    if (marca && r[C.MARCA] !== marca) return false;
    if (aplic && r[C.APLICACION] !== aplic) return false;
    return true;
  });
  renderTable();
  document.getElementById('results-meta').textContent =
    allData.length > 0 ? filtered.length + ' de ' + allData.length : '';
}

function clearAll() {
  document.getElementById('search-input').value = '';
  ['f-categoria','f-subcategoria','f-tipo','f-linea','f-marca','f-aplicacion']
    .forEach(id => { document.getElementById(id).value = ''; });
  closeDetail();
  applyFilters();
}

// ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderTable() {
  const wrapper = document.getElementById('table-wrapper');
  if (filtered.length === 0) {
    wrapper.innerHTML = '<div class="empty-state">No se encontraron productos</div>';
    return;
  }
  const show = filtered.slice(0, 200);
  const rows = show.map(r => {
    const idx = allData.indexOf(r);
    return '<tr onclick="showDetail(' + idx + ')" data-idx="' + idx + '">' +
      '<td class="ref-cell">' + (r[C.REF]||'‚Äî') + '</td>' +
      '<td><span class="marca-tag">' + (r[C.MARCA]||'‚Äî') + '</span></td>' +
      '<td>' + (r[C.PRODUCTO]||'‚Äî') + '</td>' +
      '</tr>';
  }).join('');
  wrapper.innerHTML =
    '<table><thead><tr><th>REFERENCIA</th><th>MARCA</th><th>PRODUCTO ‚ñ≤</th></tr></thead>' +
    '<tbody>' + rows + '</tbody></table>' +
    (filtered.length > 200 ? '<div class="more-results">Mostrando 200 de ' + filtered.length + ' resultados. Refina tu b√∫squeda.</div>' : '');
}

// ‚îÄ‚îÄ DETAIL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function extractDriveId(url) {
  if (!url) return null;
  const m1 = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
  if (m1) return m1[1];
  const m2 = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
  if (m2) return m2[1];
  return null;
}

async function loadImage(fileId, imgEl) {
  try {
    const res = await fetch(APPS_SCRIPT_URL + '?key=' + ACCESS_KEY + '&img=' + fileId);
    const dataUrl = await res.text();
    if (dataUrl.startsWith('data:')) imgEl.src = dataUrl;
    else imgEl.style.display = 'none';
  } catch(e) { imgEl.style.display = 'none'; }
}

function showDetail(idx) {
  const r = allData[idx];
  if (!r) return;
  document.querySelectorAll('tbody tr').forEach(tr => tr.classList.remove('selected'));
  const tr = document.querySelector('tr[data-idx="' + idx + '"]');
  if (tr) tr.classList.add('selected');

  const inv = parseFloat(r[C.INV]) || 0;
  const invClass = inv > 10 ? 'inv-ok' : inv > 0 ? 'inv-low' : 'inv-none';
  const invText = inv > 10 ? inv + ' und.' : inv > 0 ? inv + ' und. (bajo)' : 'Sin stock';
  const fileId = extractDriveId(r[C.FOTO]);

  const imgHtml = fileId
    ? '<div class="product-img-wrap"><img id="detail-img" class="product-image" alt="Foto producto"><a class="ver-completa" id="ver-completa-link">Ver imagen completa</a></div>'
    : '<div class="product-img-wrap"><div class="no-image">Sin imagen</div></div>';

  document.getElementById('detail-body').innerHTML =
    '<div class="detail-grid">' +
      '<div>' +
        imgHtml +
        '<div class="info-section">' +
          '<div class="info-section-title">Informaci√≥n del producto</div>' +
          '<table class="info-table">' +
            irow('REFERENCIA', r[C.REF]) +
            irow('REFERENCIAS ALTERNAS Y/O INTERCAMBIO', r[C.ALTERNOS] || 'No hay datos') +
            irow('PRODUCTO', r[C.PRODUCTO]) +
            irow('L√çNEA', r[C.LINEA]) +
            irow('MARCA', r[C.MARCA]) +
            irow('APLICACI√ìN', r[C.APLICACION]) +
          '</table>' +
        '</div>' +
      '</div>' +
      '<div>' +
        '<div class="info-section">' +
          '<div class="info-section-title">Informaci√≥n comercial</div>' +
          '<table class="info-table">' +
            irow('CONDICI√ìN', r[C.CONDICION] || 'No hay datos') +
            '<tr><td>INV.</td><td><span class="inv-badge ' + invClass + '">' + invText + '</span></td></tr>' +
            irow('PRECIO BRUTO UNITARIO', formatPrice(r[C.PRECIO_BRUTO])) +
            irow('NETO -5%', formatPrice(r[C.NETO_5])) +
            irow('NETO -8%', formatPrice(r[C.NETO_8])) +
            irow('PRECIO PROMO NETO X ESCALA', formatPrice(r[C.PRECIO_PROMO])) +
            irow('UND ESCALA IGUAL O MAYOR', r[C.UND_ESCALA] || '0') +
            irow('UND MIN VTA', r[C.UND_MIN] || '0') +
            irow('UND MAX VTA', r[C.UND_MAX] || '0') +
            irow('PROMO FINALIZA EN:', r[C.PROMO_FIN] || '0') +
            irow('UND RMC', r[C.UND_RMC] || '0') +
          '</table>' +
        '</div>' +
      '</div>' +
    '</div>';

  const panel = document.getElementById('detail-panel');
  panel.classList.add('visible');
  panel.scrollIntoView({ behavior: 'smooth', block: 'start' });

  if (fileId && navigator.onLine) {
    const imgEl = document.getElementById('detail-img');
    if (imgEl) {
      loadImage(fileId, imgEl);
      const verLink = document.getElementById('ver-completa-link');
      if (verLink) verLink.onclick = () => window.open(r[C.FOTO], '_blank');
    }
  }
}

function closeDetail() {
  document.getElementById('detail-panel').classList.remove('visible');
  document.querySelectorAll('tbody tr').forEach(tr => tr.classList.remove('selected'));
}

function irow(label, val) {
  return '<tr><td>' + label + '</td><td>' + (val||'‚Äî') + '</td></tr>';
}
function formatPrice(val) {
  if (!val || val === '0') return '$0';
  const n = parseFloat(String(val).replace(/[^0-9.]/g, ''));
  if (isNaN(n)) return val;
  return '$ ' + n.toLocaleString('es-CO', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
}
</script>
</body>
</html>
